<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur WebP Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="evoail.png">
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* Variables de couleurs (Th√®me Clair par d√©faut) */
        :root {
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --shadow: rgb(0 0 0 / 0.1);
        }

        /* Th√®me Sombre */
        body.dark-mode {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --text-main: #f3f4f6;
            --text-sec: #9ca3af;
            --input-bg: #374151;
            --input-border: #4b5563;
            --shadow: rgb(0 0 0 / 0.5);
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background: var(--card-bg);
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px var(--shadow);
            text-align: center;
            max-width: 450px;
            width: 100%;
            position: relative;
            transition: background-color 0.3s;
        }

        h1 { margin-bottom: 0.5rem; color: var(--text-main); }
        p { color: var(--text-sec); margin-bottom: 2rem; }

        input[type="text"] {
            width: 80%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-main);
            border-radius: 6px;
            outline: none;
        }

        .btn {
            display: block;
            width: 100%;
            border: none;
            color: white;
            background-color: #2563eb;
            padding: 15px 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }
        .btn:hover { opacity: 0.9; }

        .upload-wrapper { position: relative; overflow: hidden; margin-bottom: 10px; }
        .upload-wrapper input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        
        #status { margin-top: 15px; font-size: 0.9rem; color: var(--text-sec); min-height: 20px; }

        /* Bouton Dark Mode */
        #themeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #themeToggle:hover { background-color: var(--input-border); }
    </style>
</head>
<body class="dark-mode"> <div class="card">
    <button id="themeToggle" title="Changer le th√®me">üåô</button>

    <h1>üì¶ Convertisseur & Zip</h1>
    <p>Convertit en WebP et cr√©e un dossier ZIP.</p>

    <input type="text" id="folderName" placeholder="Nom du dossier (ex: produit-tshirt)" value="images-webp">

    <div class="upload-wrapper">
        <button class="btn" style="background:#475569">üìÇ Choisir les images</button>
        <input type="file" id="fileInput" multiple accept="image/*">
    </div>

    <button id="downloadBtn" class="btn" style="display:none; background:#059669">‚¨áÔ∏è T√©l√©charger le ZIP</button>

    <div id="status"></div>
</div>

<script>
    // --- Gestion du Dark Mode ---
    const toggleBtn = document.getElementById('themeToggle');
    const body = document.body;

    // V√©rifier si l'utilisateur avait d√©j√† une pr√©f√©rence
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        body.className = savedTheme; // Applique 'dark-mode' ou ''
        updateIcon();
    }

    toggleBtn.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        // Sauvegarder la pr√©f√©rence
        localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark-mode' : '');
        updateIcon();
    });

    function updateIcon() {
        if (body.classList.contains('dark-mode')) {
            toggleBtn.textContent = '‚òÄÔ∏è'; // Afficher soleil si mode sombre actif
        } else {
            toggleBtn.textContent = 'üåô'; // Afficher lune si mode clair actif
        }
    }
    // Initialisation de l'icone
    updateIcon();


    // --- Logique de conversion (Inchang√©e) ---
    const fileInput = document.getElementById('fileInput');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusDiv = document.getElementById('status');
    const folderInput = document.getElementById('folderName');
    
    let zip = new JSZip();
    let processedCount = 0;
    let totalFiles = 0;

    fileInput.addEventListener('change', function(e) {
        if (!this.files.length) return;
        
        zip = new JSZip();
        processedCount = 0;
        totalFiles = this.files.length;
        downloadBtn.style.display = 'none';
        statusDiv.textContent = `Conversion de ${totalFiles} images en cours...`;

        Array.from(this.files).forEach(file => processFile(file));
    });

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const dataUrl = canvas.toDataURL('image/webp', 0.80);
                const base64 = dataUrl.split(',')[1];
                
                const originalName = file.name.substring(0, file.name.lastIndexOf('.'));
                zip.file(originalName + ".webp", base64, {base64: true});

                processedCount++;
                statusDiv.textContent = `Traitement : ${processedCount} / ${totalFiles}`;

                if (processedCount === totalFiles) {
                    statusDiv.textContent = "‚úÖ Pr√™t ! Cliquez sur t√©l√©charger.";
                    downloadBtn.style.display = 'block';
                }
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    downloadBtn.addEventListener('click', function() {
        statusDiv.textContent = "G√©n√©ration du ZIP...";
        zip.generateAsync({type:"blob"}).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            const name = folderInput.value || "images-webp";
            link.download = name + ".zip";
            link.click();
            statusDiv.textContent = "ZIP t√©l√©charg√© !";
        });
    });

    // PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>

</body>
</html>
