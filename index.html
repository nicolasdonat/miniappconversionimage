<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertisseur WebP Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; height: 100vh; margin: 0; display: flex; justify-content: center; align-items: center; background-color: #f3f4f6; }
        .card { background: white; padding: 2.5rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); text-align: center; max-width: 450px; width: 100%; }
        input[type="text"] { width: 80%; padding: 10px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .btn { display: block; width: 100%; border: none; color: white; background-color: #2563eb; padding: 15px 0; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:hover { background-color: #1d4ed8; }
        .upload-wrapper { position: relative; overflow: hidden; margin-bottom: 10px; }
        .upload-wrapper input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        #status { margin-top: 15px; font-size: 0.9rem; color: #64748b; min-height: 20px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üì¶ Convertisseur & Zip</h1>
    <p>Convertit en WebP et cr√©e un dossier ZIP.</p>

    <input type="text" id="folderName" placeholder="Nom du dossier (ex: produit-tshirt)" value="images-webp">

    <div class="upload-wrapper">
        <button class="btn" style="background:#475569">üìÇ Choisir les images</button>
        <input type="file" id="fileInput" multiple accept="image/*">
    </div>

    <button id="downloadBtn" class="btn" style="display:none; background:#059669">‚¨áÔ∏è T√©l√©charger le ZIP</button>

    <div id="status"></div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusDiv = document.getElementById('status');
    const folderInput = document.getElementById('folderName');
    
    let zip = new JSZip();
    let processedCount = 0;
    let totalFiles = 0;

    fileInput.addEventListener('change', function(e) {
        if (!this.files.length) return;
        
        // Reset
        zip = new JSZip();
        processedCount = 0;
        totalFiles = this.files.length;
        downloadBtn.style.display = 'none';
        statusDiv.textContent = `Conversion de ${totalFiles} images en cours...`;

        Array.from(this.files).forEach(file => processFile(file));
    });

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                // Conversion WebP
                const dataUrl = canvas.toDataURL('image/webp', 0.80);
                
                // Retirer l'en-t√™te data:image... pour le zip
                const base64 = dataUrl.split(',')[1];
                
                // Nom du fichier
                const originalName = file.name.substring(0, file.name.lastIndexOf('.'));
                zip.file(originalName + ".webp", base64, {base64: true});

                processedCount++;
                statusDiv.textContent = `Traitement : ${processedCount} / ${totalFiles}`;

                if (processedCount === totalFiles) {
                    statusDiv.textContent = "‚úÖ Pr√™t ! Cliquez sur t√©l√©charger.";
                    downloadBtn.style.display = 'block';
                }
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    downloadBtn.addEventListener('click', function() {
        statusDiv.textContent = "G√©n√©ration du ZIP...";
        zip.generateAsync({type:"blob"}).then(function(content) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            const name = folderInput.value || "images-webp";
            link.download = name + ".zip";
            link.click();
            statusDiv.textContent = "ZIP t√©l√©charg√© !";
        });
    });

    // Enregistrement du Service Worker pour la PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
</script>

</body>
</html>
